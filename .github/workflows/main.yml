name: Test Tauri build

on:
    - push
    - pull_request

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                platform: [macos-latest, ubuntu-latest, windows-latest]

        runs-on: ${{ matrix.platform }}
        steps:
            - { name: "Checkout the code", uses: actions/checkout@v2 }

            - name: Setup Rust cache
              uses: actions/cache@v2
              with:
                  key: ${{ runner.os }}-${{ hashFiles('src-tauri/Cargo.lock') }}
                  path: |
                    ~/.cargo/registry/index
                    ~/.cargo/registry/cache
                    ~/.cargo/git
                    ./src-tauri/target

            - name: üçÉ Install Node.js
              uses: actions/setup-node@v1
              with:
                  node-version: 16
                  cache: yarn
                  cache-dependency-path: |
                      yarn.lock
                      webdriver/webdriverio/yarn.lock

            - name: ü¶Ä Install Rust
              uses: actions-rs/toolchain@v1
              with: { toolchain: stable }

            - name: Install webkit2gtk (ubuntu only)
              if: matrix.platform == 'ubuntu-latest'
              run: |
                  sudo apt-get update
                  sudo apt-get upgrade -y --no-install-recommends webkit2gtk-4.0

            - name: Install dependencies
              run: yarn install

            - name: Build frontend
              run: yarn build

            - name: Build application
              run: yarn tauri build
